datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

//////////////////////
// ENUMS
//////////////////////

enum UserRole {
  SUPERADMIN
  ADMIN
  CUSTOMER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  READY
  COMPLETED
  CANCELED
  FAILED
}

//////////////////////
// MODELS
//////////////////////

model User {
  id        String     @id @default(uuid()) @db.Uuid
  email     String     @unique
  name      String
  password  String
  phone     String?
  address   String?
  role      UserRole   @default(SUPERADMIN)
  status    UserStatus @default(ACTIVE)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  orders    Order[]
  ratings   Rating[]
  cartItems CartItem[]
  otp       Otp[]
  visits    VisitorTracking[]

  @@map("users")
}

model Category {
  id        String      @id @default(uuid()) @db.Uuid
  title     String
  description String?
  image     String?
  parentId  String?     @db.Uuid @map("parent_id")
  parent    Category?   @relation("CategoryToCategory", fields: [parentId], references: [id])
  children  Category[]  @relation("CategoryToCategory")

  products  Product[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("categories")
}

model Product {
  id            String   @id @default(uuid()) @db.Uuid
  title         String
  description   String
  categoryId    String?  @db.Uuid @map("category_id")
  category      Category? @relation(fields: [categoryId], references: [id])
  price         Decimal  @db.Decimal(10,2)
  images        String[]
  averageRating Decimal  @default(0) @db.Decimal(3,2) @map("average_rating")
  slug          String?  @unique

  variants   ProductVariant[]
  orderItems OrderItem[]
  ratings    Rating[]
  cartItems  CartItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("products")
}

model ProductVariant {
  id        String   @id @default(uuid()) @db.Uuid
  productId String   @db.Uuid @map("product_id")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  color String?
  size  String?
  unit  String?

  price Decimal @db.Decimal(10,2)

  orderItems OrderItem[]
  cartItems  CartItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("product_variants")
}

model Order {
  id          String      @id @default(uuid()) @db.Uuid
  orderNumber String?     @unique @map("order_number")
  userId      String      @db.Uuid @map("user_id")
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  totalPrice  Decimal     @db.Decimal(12,2) @map("total_price")
  shippingInfo String     @map("shipping_info")
  status      OrderStatus @default(PENDING)

  items OrderItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid()) @db.Uuid
  orderId   String   @db.Uuid @map("order_id")
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String   @db.Uuid @map("product_id")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  variantId String?  @db.Uuid @map("variant_id")
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  quantity  Int
  price     Decimal @db.Decimal(10,2)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("order_items")
}

model CartItem {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String   @db.Uuid @map("product_id")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  variantId String?  @db.Uuid @map("variant_id")
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  quantity  Int
  price     Decimal  @db.Decimal(10,2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, productId, variantId])
  @@map("cart_items")
}

model Rating {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String   @db.Uuid @map("product_id")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  rating    Int
  review    String?
  moderated Boolean  @default(false)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, productId])
  @@map("ratings")
}

model Otp {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  otpHash   String   @map("otp_hash")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("otp")
}

model OrderCounter {
  yearMonth  String @id @map("year_month")
  lastNumber Int    @map("last_number")

  @@map("order_counters")
}

model VisitorTracking {
  id            String   @id @default(uuid()) @db.Uuid
  sessionId     String   @map("session_id")
  userId        String?  @db.Uuid @map("user_id")
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  ipAddress     String?  @map("ip_address")
  location      String?
  deviceInfo    String?  @map("device_info")

  pagesVisited  String[] @default([])
  productClicks String[] @default([])
  searches      String[] @default([])

  duration      Int?
  visitedAt     DateTime @default(now()) @map("visited_at")
  updatedAt     DateTime? @map("updated_at")

  @@map("visitor_tracking")
}